{% extends 'base.html' %}

{% block content %}
    <body>
    <p>ISBN: {{book.isbn}}</p>
    <h2>{{book.title}}</h2>
    <img src={{book.image_url_m}} alt={{book.title}}>
    <h4>Written by {{book.author}}</h4>
    <p>Published in {{book.year_of_publish}}</p>

    <button id="like" onclick="like({{book.pk}})">Like</button>
    <table id ="likedBy">
    </table>

    <br>

    <h5>Comments</h5>
    <form id="comment-form" method="post" data-book-id="{{ book.pk }}">
        {% csrf_token %}
        <textarea id="comment-textarea" name="comment-textarea" class="form-control"></textarea>
    </form>
    <button id="add-comment-btn" type="submit" class="btn btn-primary" style="margin-top: 8px;" onclick="addComment({{book.pk}})">Post Comment</button>
    <table id="comment-table"></table>

    <!-- <form id="comment-form" method="post" data-book-id="{{ book.pk }}">
        {% csrf_token %}
        <textarea id="comment-textarea" name="comment-textarea" rows="4" cols="50"></textarea>
    </form> -->

    <script>
        /*
        Pas pertama kali window load, cek apakah user pernah like bukunya
        Setelah itu build html yg isinya semua orang yg pernah like
        */
        window.onload = function(){
            const form = new FormData()
            form.append("id", {{book.pk}})
            console.log({{book.pk}})

            fetch("{% url 'main:like_dislike' %}",{
                method : "POST",
                body : form
            }).then((like_or_dislike) => like_or_dislike.json()).then((res) => did_like(res)).then((data) => build_like({{book.pk}}))

            fetch("{% url 'main:get_comments_ajax' %}", {
                method: "POST",
                body: form
            }).then((res) => res.json()).then(() => getComments({{book.pk}})).then(() => refreshComments({{book.pk}}))
        }

        /*
        Function yang berguna untuk menambahkan like ke buku lalu merubah isi tabel user
        yang pernah like bukunya
        menerima parameter id buku
        */
        // ID user
        async function like(id){
            const formData = new FormData()
            formData.append("id", id)

            const form = new FormData()
            form.append("id", id)
            
            fetch("{% url 'main:add_like_ajax' %}", {
                method: "POST",
                body: formData
            }).then(data => fetch("{% url 'main:like_dislike' %}",{
                method : "POST",
                body : form
            })).then((like_or_dislike) => like_or_dislike.json()).then((res) => did_like(res)).then((data) => build_like({{book.pk}}))
        }

        /*
        Function untuk mengubah tabel berisi user yang pernah like
        digunakan untuk DEBUGGING. jika ingin di-comment out silahkan saja
        Menerima id buku
        */
        async function build_like(id){
            var likes = await see_like(id)
            res = `<tr>
                <th>by</th>
                <th>book</th>
                </tr>`
            console.log("likes "+ likes)
            likes.forEach((l)=>{
                res+=`\n<tr>
                    <td>${l.fields.user}</td>
                    <td>${l.fields.book}</td>
                </tr>` 
            })
            document.getElementById('likedBy').innerHTML =res
        }

        /*
        Function yang cek apakah user pernah like bukunya
        Menerima parameter json yang berisi 1 atau 0 like milik request.user terhadap buku
        */
        function did_like(like_or_dislike){
            var like_or_dislike = like_or_dislike
            var length_temp=0
            // console.log("did_like "+ like_or_dislike)
            like_or_dislike.forEach((lod)=>{
                length_temp+=1
            })

            // console.log(length_temp)

            if(length_temp==1){
                document.getElementById('like').style.color = "blue";
            }
            else{
                document.getElementById('like').style.color = "black";
            }
        }

        /*
        Function ini untuk MENDAPATKAN siapa saja yang like buku ini.
        digunakan untuk debugging, sehingga jika ingin di comment out silahkan
        menerima parameter id buku.
        */
        async function see_like(bookId){
            const formData= new FormData()
            formData.append("id", bookId)
            return fetch("{% url 'main:see_like_ajax' %}", {
                method: "POST",
                body: formData
            }).then((res) => res.json())
        }
        

        const bookIdComment = {{book.pk}}

        async function getComments(id) {
            console.log("Inside getComments function");
            const formData = new FormData()
            formData.append("id", id)
            return fetch("{% url 'main:get_comments_ajax' %}", {
                method: "POST",
                body: formData
            }).then((res) => res.json())
        }

        async function addComment(id) {
            console.log("Inside addComment function");
            const form = document.querySelector('#comment-form');
            fetch("{% url 'main:add_comment_ajax' %}", {
                method: "POST",
                body: new FormData(form)
            }).then(res => res.json()).then((data) => {
                console.log("Comment added successfully:", data); refreshComments(bookIdComment); form.reset})

            console.log("abis manggil url")

            // form.reset()
            return false
        }

        async function refreshComments(id) {
            document.getElementById("comment-table").innerHTML = ""
            
            const comments = await getComments(bookIdComment)
            let htmlString = `<tr>
                <th>Name</th>
                <th>Comment</th>
            </tr>`

            comments.forEach((com) => {
                htmlString += `\n<tr>
                <td>${com.user}</td>
                <td>${com.comment}</td>
            </tr>` 
            })

            document.getElementById("comment-table").innerHTML = htmlString
        }
        
        document.getElementById("add-comment-btn").onclick = addComment(bookIdComment)
        
        refreshComments(bookIdComment)
    </script>

{% endblock content %}