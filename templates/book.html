{% extends 'base.html' %}

{% block content %}
<div class="container" style="color: #ffffff; text-align: center; margin-bottom: 40px;">
    <h1 style="margin-bottom: 60px;">Book Detail</h1>
    <div class="row">
        <div class="col-md-6">
            <img src="{{book.image_url_l}}" alt="{{book.title}}" class="img-fluid" style="margin: 0 auto;">
        </div>
        <div class="col-md-6" style="text-align: left;">
            <p>ISBN: {{book.isbn}}</p>
            <h4>{{book.title}}</h4>
            <h4>Written by {{book.author}}</h4>
            <p>Published in {{book.year_of_publish}}</p>
            <button id="like" onclick="like({{book.pk}})" class="btn btn-link"><i class="far fa-thumbs-up fa-2x" id="like-icon"></i></button>
            <div id="likedBy" style="margin-top: 20px;"></div>
        </div>
    </div>
</div>

<script>
    async function see_like(bookId) {
        const formData = new FormData();
        formData.append("id", bookId);
        return fetch("{% url 'main:see_like_ajax' %}", {
            method: "POST",
            body: formData
        }).then((res) => res.json());
    }

    function did_like(like_or_dislike) {
        var length_temp = like_or_dislike.length;
        var likeIcon = document.getElementById('like-icon');
        if (length_temp === 1) {
            likeIcon.classList.add('fas');
            likeIcon.classList.remove('far');
            likeIcon.style.color = '#5799ef';
        } else {
            likeIcon.classList.remove('fas');
            likeIcon.classList.add('far');
            likeIcon.style.color = '#808080';
        }
    }

    async function build_like(id) {
        var likes = await see_like(id);
        var res = `<table class="table table-striped">
            <thead>
                <tr>
                    <th>by</th>
                    <th>book</th>

                </tr>
            </thead>
            <tbody>`;

        likes.forEach((l) => {
            res += "<tr>";
            res += "<td><a href=\"{% url 'main:profile' user_id=123 %}\">".replace("123", l.fields.user) + l.fields.user + "</a></td>";
            res += "</tr>";
        });

        res += "</tbody></table>";
        document.getElementById('likedBy').innerHTML = res;
    }

    async function like(id) {
        const formData = new FormData();
        formData.append("id", id);

        const form = new FormData();
        form.append("id", id);

        fetch("{% url 'main:add_like_ajax' %}", {
            method: "POST",
            body: formData
        }).then(() => {
            return fetch("{% url 'main:like_dislike' %}", {
                method: "POST",
                body: form
            });
        }).then((like_or_dislike) => like_or_dislike.json()).then((res) => did_like(res)).then((data) => build_like(id));
    }

    window.onload = function () {
        const form = new FormData();
        form.append("id", {{book.pk}});
        fetch("{% url 'main:like_dislike' %}", {
            method: "POST",
            body: form
        }).then((like_or_dislike) => like_or_dislike.json()).then((res) => did_like(res)).then(() => build_like({{book.pk}}));
    };
</script>
{% endblock %}
